
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Aquilify is an ASGI (Asynchronous Server Gateway Interface) framework designed to facilitate the development of web applications with Python.">
      
      
      
        <link rel="canonical" href="https://aquilify.vvfin.in/middleware/">
      
      
        <link rel="prev" href="../routing/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>Middleware - AQUILIFY</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-middleware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AQUILIFY" class="md-header__button md-logo" aria-label="AQUILIFY" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AQUILIFY
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Middleware
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/embrake/aquilify" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    embrake/aquilify
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AQUILIFY" class="md-nav__button md-logo" aria-label="AQUILIFY" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    AQUILIFY
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/embrake/aquilify" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    embrake/aquilify
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../curd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Curd-Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../requests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Request
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../response/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Response
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../websocket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Websocket
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../routing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Routing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Middleware
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Middleware
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      Using Middleware
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pure-asgi-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      Pure ASGI Middleware
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pure ASGI Middleware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#writing-pure-asgi-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      Writing pure ASGI middleware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aquilify-dynamic-middleware-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Aquilify Dynamic Middleware Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decorator-style-middleware-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Decorator style Middleware Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      Type annotations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Common patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processing-certain-requests-only" class="md-nav__link">
    <span class="md-ellipsis">
      Processing certain requests only
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reusing-aquilify-components" class="md-nav__link">
    <span class="md-ellipsis">
      Reusing Aquilify components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspecting-or-modifying-the-request" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting or modifying the request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-information-to-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Passing information to endpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleanup-and-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Cleanup and error handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further reading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#using-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      Using Middleware
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    <span class="md-ellipsis">
      Usage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pure-asgi-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      Pure ASGI Middleware
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pure ASGI Middleware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#writing-pure-asgi-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      Writing pure ASGI middleware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aquilify-dynamic-middleware-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Aquilify Dynamic Middleware Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decorator-style-middleware-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Decorator style Middleware Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      Type annotations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Common patterns
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processing-certain-requests-only" class="md-nav__link">
    <span class="md-ellipsis">
      Processing certain requests only
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reusing-aquilify-components" class="md-nav__link">
    <span class="md-ellipsis">
      Reusing Aquilify components
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inspecting-or-modifying-the-request" class="md-nav__link">
    <span class="md-ellipsis">
      Inspecting or modifying the request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#passing-information-to-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Passing information to endpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cleanup-and-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Cleanup and error handling
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      Further reading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Middleware</h1>

<p>Aquilify includes several middleware classes for adding behavior that is applied across your entire application. These are all implemented as standard ASGI middleware classes, and can be applied either to Aquilify or to any other ASGI application.</p>
<h2 id="using-middleware"><b>Using Middleware</b></h2>
<p>The Aquilify application class allows you to include the ASGI middleware in a way that ensures that it remains wrapped by the exception handler.</p>
<p>Setup and new project using <code>aquilify create-app</code> called <code>mdls</code></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>Aquilify</code> comes with some default <code>middlewares</code> integrated.
<div class="highlight"><pre><span></span><code><span class="nv">MIDDLEWARES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.XFrameOptionsMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.GzipMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.StaticMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.TrustedhostMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.CSRFMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.MediaMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.middlewares.ConditionalGetMiddleware&quot;</span>,
<span class="w">    </span><span class="s2">&quot;aquilify.core.messages.middleware.MessageMiddleware&quot;</span>,
<span class="o">]</span>
</code></pre></div></p>
</div>
<h2 id="usage"><b>Usage</b></h2>
<p>To implement a middleware class, you must override the
<code>async def dispatch(request, response)</code> method.</p>
<p>Create a new directory <code>middleware</code> <code>mdls/middleware</code> and the the <code>__init__.py</code> then create a file <code>logging.py</code>.</p>
<p><code>logging.py</code>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoggingMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="s2">&quot;Request Found from </span><span class="si">{}</span><span class="s2">, Method: </span><span class="si">{}</span><span class="s2">, Status: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
    <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span> <span class="c1"># -&gt; Object(Response)</span>
</code></pre></div>
Now update the <code>settings.py</code> with the <code>LoggingMiddleware</code>.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">MIDDLEWARES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;aquilify.middlewares.XFrameOptionsMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.GzipMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.StaticMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.TrustedhostMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.CSRFMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.MediaMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.ConditionalGetMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.core.messages.middleware.MessageMiddleware&quot;</span><span class="p">,</span>
<span class="hll">    <span class="s2">&quot;middleware.logging.LoggingMiddleware&quot;</span>
</span><span class="p">]</span>
</code></pre></div>
Add the <code>LoggingMiddleware</code> instance the <code>MIDDLEWARES</code> list, the <code>Aquilify</code> automatically get the <code>LoggingMiddleware</code> instace from it's path and add it in <code>middleware</code> executor.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently Middleware are only support to interfare with the response if you try to refactor the <code>before request</code> if can't be possible.
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">mymiddleware</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="c1"># request.name = &#39;test&#39; this thing isn&#39;t possbile till now.</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># you can make further changes `after the response`.</span>
    <span class="n">retun</span> <span class="n">response</span>
    <span class="c1"># the response object already taken the request so you must have to return the `response` to next `middleware` or next `handler`.</span>
</code></pre></div>
but we have a better and even more powerful solution for this error you can try out own <code>Stage Hanlders</code> which can able to refactor the <code>before request</code> &amp; <code>after response</code>.
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BeforeRequestStageHandler</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
        <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:8000&#39;</span>
</code></pre></div>
You can interect with the <code>before request</code> with the help of StageHandlers the complete documantation available at StageHandlers.</p>
</div>
<h2 id="pure-asgi-middleware"><b>Pure ASGI Middleware</b></h2>
<p>The <a href="https://asgi.readthedocs.io/en/latest/">ASGI spec</a> makes it possible to implement ASGI middleware using the ASGI interface directly, as a chain of ASGI applications that call into the next one. In fact, this is how middleware classes shipped with Aquilify are implemented.</p>
<h3 id="writing-pure-asgi-middleware"><b>Writing pure ASGI middleware</b></h3>
<p>The most common way to create an ASGI middleware is with a class.</p>
<p><code>mdls/middleware/asgi_middleware.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ASGIMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
</code></pre></div>
<p>The middleware above is the most basic ASGI middleware. It receives a parent ASGI application as an argument for its constructor, and implements an <code>async __call__</code> method which calls into that parent application.</p>
<p><code>mdls/settings.py</code></p>
<div class="highlight"><pre><span></span><code><span class="n">MIDDLEWARES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;aquilify.middlewares.XFrameOptionsMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.GzipMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.StaticMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.TrustedhostMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.CSRFMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.MediaMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.middlewares.ConditionalGetMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;aquilify.core.messages.middleware.MessageMiddleware&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;middleware.asgi_middleware.ASGIMiddleware&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__init__&quot;</span><span class="p">:</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="mi">6</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<h3 id="aquilify-dynamic-middleware-configuration"><b>Aquilify Dynamic Middleware Configuration</b></h3>
<p>Aquilify offers a robust dynamic middleware configuration catering to middleware that overrides application behavior, such as the <code>ASGIMiddleware</code>. This specialized middleware, operating as a pure <code>ASGI</code> Middleware, initializes the app instance.</p>
<p>When configuring a dict within the <code>MIDDLEWARES</code> list, provide a key named <code>origin</code>, specifying the path to the middleware. If your middleware requires access to the current app instance through its <code>__init__</code> method, include an argument for <code>app</code>. By setting up the <code>__init__</code> key as app within the <code>MIDDLEWARES</code> list of type <code>List[Dict]</code>, <code>Aquilify</code> automatically passes the current <code>app</code> instance to facilitate seamless integration.</p>
<h3 id="decorator-style-middleware-configuration"><b>Decorator style Middleware Configuration</b></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">asgi_middleware</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">asgi_decorator</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">wrapped_app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped_app</span>

    <span class="k">return</span> <span class="n">asgi_decorator</span>
</code></pre></div>
<p>In any case, ASGI middleware must be callables that accept three arguments: <code>scope</code>, <code>receive</code>, and <code>send</code>.</p>
<ul>
<li><code>scope</code> is a dict holding information about the connection, where <code>scope["type"]</code> may be:<ul>
<li><a href="https://asgi.readthedocs.io/en/latest/specs/www.html#http-connection-scope"><code>"http"</code></a>: for HTTP requests.</li>
<li><a href="https://asgi.readthedocs.io/en/latest/specs/www.html#websocket-connection-scope"><code>"websocket"</code></a>: for WebSocket connections.</li>
<li><a href="https://asgi.readthedocs.io/en/latest/specs/lifespan.html#scope"><code>"lifespan"</code></a>: for ASGI lifespan messages.</li>
</ul>
</li>
<li><code>receive</code> and <code>send</code> can be used to exchange ASGI event messages with the ASGI server â€” more on this below. The type and contents of these messages depend on the scope type. Learn more in the <a href="https://asgi.readthedocs.io/en/latest/specs/index.html">ASGI specification</a>.</li>
</ul>
<h3 id="type-annotations">Type annotations</h3>
<p>There are two ways of annotating a middleware: using Aquilify itself or <a href="https://github.com/django/asgiref"><code>asgiref</code></a>.</p>
<ul>
<li>Using Aquilify: for most common use cases.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aquilify.types</span> <span class="kn">import</span> <span class="n">ASGIApp</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">Scope</span><span class="p">,</span> <span class="n">Receive</span><span class="p">,</span> <span class="n">Send</span>


<span class="k">class</span> <span class="nc">ASGIMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">ASGIApp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">:</span> <span class="n">Receive</span><span class="p">,</span> <span class="n">send</span><span class="p">:</span> <span class="n">Send</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">send_wrapper</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ... Do something</span>
            <span class="k">await</span> <span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send_wrapper</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Using <a href="https://github.com/django/asgiref"><code>asgiref</code></a>: for more rigorous type hinting.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">asgiref.typing</span> <span class="kn">import</span> <span class="n">ASGI3Application</span><span class="p">,</span> <span class="n">ASGIReceiveCallable</span><span class="p">,</span> <span class="n">ASGISendCallable</span><span class="p">,</span> <span class="n">Scope</span>
<span class="kn">from</span> <span class="nn">asgiref.typing</span> <span class="kn">import</span> <span class="n">ASGIReceiveEvent</span><span class="p">,</span> <span class="n">ASGISendEvent</span>


<span class="k">class</span> <span class="nc">ASGIMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">ASGI3Application</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">:</span> <span class="n">ASGIReceiveCallable</span><span class="p">,</span> <span class="n">send</span><span class="p">:</span> <span class="n">ASGISendCallable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">send_wrapper</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">ASGISendEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># ... Do something</span>
            <span class="k">await</span> <span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send_wrapper</span><span class="p">)</span>
</code></pre></div>
<h3 id="common-patterns">Common patterns</h3>
<h4 id="processing-certain-requests-only">Processing certain requests only</h4>
<p>ASGI middleware can apply specific behavior according to the contents of <code>scope</code>.</p>
<p>For example, to only process HTTP requests, write this...</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ASGIMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="o">...</span>  <span class="c1"># Do something here!</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
</code></pre></div>
<p>Likewise, WebSocket-only middleware would guard on <code>scope["type"] != "websocket"</code>.</p>
<p>The middleware may also act differently based on the request method, URL, headers, etc.</p>
<h4 id="reusing-aquilify-components">Reusing Aquilify components</h4>
<p>Aquilify provides several data structures that accept the ASGI <code>scope</code>, <code>receive</code> and/or <code>send</code> arguments, allowing you to work at a higher level of abstraction. Such data structures include <a href="../requests/#request"><code>Request</code></a>, <a href="../requests/#headers"><code>Headers</code></a>, <a href="../requests/#query-parameters"><code>QueryParams</code></a>, <a href="../requests/#url"><code>URL</code></a>, etc.</p>
<p>For example, you can instantiate a <code>Request</code> to more easily inspect an HTTP request:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aquilify.wrappers</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="k">class</span> <span class="nc">ASGIMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http&quot;</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
            <span class="o">...</span> <span class="c1"># Use `request.method`, `request.url`, `request.headers`, etc.</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
</code></pre></div>
<p>You can also reuse <a href="../response/">responses</a>, which are ASGI applications as well.</p>
<h4 id="inspecting-or-modifying-the-request">Inspecting or modifying the request</h4>
<p>Request information can be accessed or changed by manipulating the <code>scope</code>. For a full example of this pattern, see Uvicorn's <a href="https://github.com/encode/uvicorn/blob/fd4386fefb8fe8a4568831a7d8b2930d5fb61455/uvicorn/middleware/proxy_headers.py"><code>ProxyHeadersMiddleware</code></a> which inspects and tweaks the <code>scope</code> when serving behind a frontend proxy.</p>
<p>Besides, wrapping the <code>receive</code> ASGI callable allows you to access or modify the HTTP request body by manipulating <a href="https://asgi.readthedocs.io/en/latest/specs/www.html#request-receive-event"><code>http.request</code></a> ASGI event messages.</p>
<p>As an example, this middleware computes and logs the size of the incoming request body...</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoggedRequestBodySizeMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;http&quot;</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">body_size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_logging_request_body_size</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">body_size</span>

            <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">receive</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;http.request&quot;</span>

            <span class="n">body_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;more_body&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size of request body was: </span><span class="si">{</span><span class="n">body_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">message</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive_logging_request_body_size</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
</code></pre></div>
<p>Likewise, WebSocket middleware may manipulate <a href="https://asgi.readthedocs.io/en/latest/specs/www.html#receive-receive-event"><code>websocket.receive</code></a> ASGI event messages to inspect or alter incoming WebSocket data.</p>
<p>For an example that changes the HTTP request body, see <a href="https://github.com/florimondmanca/msgpack-asgi"><code>msgpack-asgi</code></a>.</p>
<h4 id="passing-information-to-endpoints">Passing information to endpoints</h4>
<p>If you need to share information with the underlying app or endpoints, you may store it into the <code>scope</code> dictionary. Note that this is a convention -- for example, Aquilify uses this to share routing information with endpoints -- but it is not part of the ASGI specification. If you do so, be sure to avoid conflicts by using keys that have low chances of being used by other middleware or applications.</p>
<p>For example, when including the middleware below, endpoints would be able to access <code>request.scope["asgi_transaction_id"]</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uuid</span>

<span class="k">class</span> <span class="nc">TransactionIDMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
        <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;asgi_transaction_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
</code></pre></div>
<h4 id="cleanup-and-error-handling">Cleanup and error handling</h4>
<p>You can wrap the application in a <code>try/except/finally</code> block or a context manager to perform cleanup operations or do error handling.</p>
<p>For example, the following middleware might collect metrics and process application exceptions...</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">MonitoringMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="o">...</span>  <span class="c1"># Process the exception</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
            <span class="o">...</span>  <span class="c1"># Submit `elapsed` as a metric to a monitoring backend</span>
</code></pre></div>
<p>See also <a href="https://github.com/steinnes/timing-asgi"><code>timing-asgi</code></a> for a full example of this pattern.</p>
<h3 id="further-reading">Further reading</h3>
<p>This documentation should be enough to have a good basis on how to create an ASGI middleware.</p>
<p>Nonetheless, there are great articles about the subject:</p>
<ul>
<li><a href="https://florimond.dev/en/posts/2019/08/introduction-to-asgi-async-python-web/">Introduction to ASGI: Emergence of an Async Python Web Ecosystem</a></li>
<li><a href="https://pgjones.dev/blog/how-to-write-asgi-middleware-2021/">How to write ASGI middleware</a></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../routing/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Routing">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Routing
              </div>
            </div>
          </a>
        
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  
    
  



  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.footer", "navigation.tabs.sticky", "search.suggest", "search.highlight"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>